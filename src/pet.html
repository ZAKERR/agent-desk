<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
:root {
  --bg: #000000;
  --color-active: #D97857;
  --color-ready: #66BF73;
  --color-permission: #6699FF;
  --color-notification: #FFB300;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
  background: var(--bg);
  overflow: hidden;
  user-select: none;
  -webkit-user-select: none;
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  color: rgba(255,255,255,0.7);
  -webkit-font-smoothing: antialiased;
}

/* ─── Pill (collapsed) ─── */
#pill {
  display: flex;
  align-items: center;
  height: 36px;
  padding: 0 14px;
  cursor: pointer;
  background: var(--bg);
}
#pill.hide { display: none; }

#pill-left {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-shrink: 0;
}
#pill-q {
  font-size: 14px;
  font-weight: 600;
  color: var(--color-active);
  display: none;
}

#pill-center {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
}
.pill-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  transition: background 0.3s;
}

#pill-right {
  display: flex;
  align-items: center;
  flex-shrink: 0;
}
#pill-hide {
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 15px;
  line-height: 1;
  color: rgba(255,255,255,0.15);
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.15s, color 0.12s;
  margin-left: 6px;
  border-radius: 4px;
  flex-shrink: 0;
}
#pill:hover #pill-hide { opacity: 1; }
#pill-hide:hover { color: rgba(255,255,255,0.5); background: rgba(255,255,255,0.08); }
.pill-spin {
  font-size: 12px;
  font-weight: bold;
  color: var(--color-active);
  width: 12px;
  text-align: center;
}
.pill-static-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
}

/* ─── Panel (expanded) ─── */
#panel {
  display: none;
  flex-direction: column;
  height: 100vh;
  background: var(--bg);
}
#panel.show { display: flex; }

/* ─── Panel Header ─── */
#panel-header {
  display: flex;
  align-items: center;
  height: 38px;
  padding: 0 14px;
  gap: 8px;
  flex-shrink: 0;
}
#header-crab { flex-shrink: 0; display: flex; align-items: center; }
#header-spacer { flex: 1; }
#header-activity {
  font-size: 14px;
  font-weight: bold;
  display: flex;
  align-items: center;
}
#header-menu {
  width: 22px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: rgba(255,255,255,0.3);
  font-size: 11px;
  border-radius: 6px;
  transition: color 0.15s, background 0.15s;
  flex-shrink: 0;
  border: none;
  background: none;
}
#header-menu:hover { color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.08); }
#header-hide {
  width: 22px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: rgba(255,255,255,0.3);
  font-size: 14px;
  border-radius: 6px;
  transition: color 0.15s, background 0.15s;
  flex-shrink: 0;
  border: none;
  background: none;
}
#header-hide:hover { color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.08); }

/* ─── Content ─── */
#content {
  flex: 1;
  overflow-y: auto;
  padding: 4px 6px;
}
#content::-webkit-scrollbar { width: 3px; }
#content::-webkit-scrollbar-track { background: transparent; }
#content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

/* ─── Session row ─── */
.sess-row {
  display: flex;
  align-items: center;
  padding: 10px 8px;
  border-radius: 12px;
  margin-bottom: 1px;
  cursor: pointer;
  transition: background 0.15s;
  gap: 12px;
}
.sess-row:hover { background: rgba(255,255,255,0.06); }

.ind { width: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.ind-dot { width: 8px; height: 8px; border-radius: 50%; }
.ind-char {
  font-size: 14px;
  font-weight: bold;
  width: 14px;
  text-align: center;
  line-height: 1;
}

/* Permission "+" rotation */
@keyframes permSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
.perm-spin {
  display: inline-block;
  animation: permSpin 2s linear infinite;
}

.sess-body { flex: 1; min-width: 0; }
.sess-name {
  font-size: 13px;
  font-weight: 500;
  color: rgba(255,255,255,0.9);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.3;
}
.sess-sub {
  font-size: 11px;
  color: rgba(255,255,255,0.5);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-top: 1px;
}
.tool-name {
  color: var(--color-ready);
  font-weight: 500;
  font-family: 'Cascadia Code', 'Consolas', monospace;
}

/* Actions */
.sess-actions {
  display: flex;
  gap: 4px;
  flex-shrink: 0;
  opacity: 0;
  transition: opacity 0.15s;
  align-items: center;
}
.sess-row:hover .sess-actions { opacity: 1; }
.sess-actions.always { opacity: 1; }

.act-btn {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  cursor: pointer;
  color: rgba(255,255,255,0.35);
  font-size: 13px;
  transition: color 0.12s, background 0.12s;
  border: none;
  background: none;
}
.act-btn:hover { color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.08); }

.perm-btn {
  padding: 5px 10px;
  border: none;
  border-radius: 14px;
  font-size: 11px;
  font-weight: 500;
  cursor: pointer;
  transition: opacity 0.12s;
  white-space: nowrap;
}
.perm-btn:hover { opacity: 0.85; }
.perm-btn.allow { background: rgba(255,255,255,0.9); color: #000; }
.perm-btn.deny  { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.6); }

.empty {
  color: rgba(255,255,255,0.15);
  text-align: center;
  padding: 32px 0;
  font-size: 11px;
}

/* ─── Settings ─── */
#settings {
  display: none;
  padding: 12px 10px;
}
.settings-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 8px;
  border-radius: 10px;
  margin-bottom: 4px;
}
.settings-label {
  font-size: 12px;
  color: rgba(255,255,255,0.6);
}
.hotkey-box {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 5px 12px;
  border-radius: 8px;
  background: rgba(255,255,255,0.08);
  color: rgba(255,255,255,0.85);
  font-size: 12px;
  font-family: 'Cascadia Code','Consolas',monospace;
  cursor: pointer;
  transition: background 0.15s;
  border: 1px solid transparent;
  min-width: 80px;
  text-align: center;
}
.hotkey-box:hover { background: rgba(255,255,255,0.12); }
.toggle-box {
  padding: 4px 14px;
  border-radius: 14px;
  font-size: 11px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.15s, color 0.15s;
  text-align: center;
  min-width: 44px;
}
.toggle-box.on { background: var(--color-ready); color: #000; }
.toggle-box.off { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.4); }
.select-box {
  padding: 4px 8px;
  border-radius: 8px;
  background: rgba(255,255,255,0.08);
  color: rgba(255,255,255,0.85);
  font-size: 11px;
  font-family: 'Segoe UI', system-ui, sans-serif;
  border: 1px solid transparent;
  cursor: pointer;
  outline: none;
}
.select-box option { background: #1a1a1a; color: #ddd; }
.hotkey-box.capturing {
  border-color: var(--color-active);
  color: var(--color-active);
  animation: capPulse 1s ease-in-out infinite;
}
@keyframes capPulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
.settings-actions {
  display: flex;
  justify-content: flex-end;
  gap: 6px;
  padding: 8px 8px 0;
}

/* ─── Chat View ─── */
#chat-view { display: none; flex-direction: column; height: calc(100vh - 38px); }
#chat-view.show { display: flex; }
#chat-header {
  display: flex; align-items: center;
  padding: 6px 8px; gap: 8px; flex-shrink: 0;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}
#chat-back {
  width: 22px; height: 22px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: rgba(255,255,255,0.4);
  font-size: 16px; border-radius: 6px;
  border: none; background: none;
  transition: color 0.15s, background 0.15s;
}
#chat-back:hover { color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.08); }
#chat-title {
  flex: 1; font-size: 12px; font-weight: 500;
  color: rgba(255,255,255,0.7);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
#chat-status {
  font-size: 10px; padding: 2px 8px;
  border-radius: 10px; font-weight: 500;
}
.cst-waiting { background: rgba(102,191,115,0.15); color: var(--color-ready); }
.cst-active  { background: rgba(217,120,87,0.15); color: var(--color-active); }
.cst-idle    { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.4); }

#chat-messages {
  flex: 1; overflow-y: auto; padding: 8px;
}
#chat-messages::-webkit-scrollbar { width: 3px; }
#chat-messages::-webkit-scrollbar-track { background: transparent; }
#chat-messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

.chat-msg {
  margin-bottom: 6px; padding: 7px 10px;
  border-radius: 10px; font-size: 12px;
  line-height: 1.5; word-wrap: break-word;
  max-width: 88%;
}
.chat-msg.user {
  background: rgba(102,153,255,0.12);
  color: rgba(255,255,255,0.85);
  margin-left: auto;
  border-bottom-right-radius: 4px;
}
.chat-msg.assistant {
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.8);
  margin-right: auto;
  border-bottom-left-radius: 4px;
}
.chat-msg.tool {
  background: rgba(102,191,115,0.06);
  color: rgba(255,255,255,0.45);
  font-size: 11px;
  font-family: 'Cascadia Code','Consolas',monospace;
  margin-right: auto;
}
.chat-empty {
  color: rgba(255,255,255,0.15);
  text-align: center; padding: 32px 0; font-size: 11px;
}

#chat-input-area {
  display: flex; align-items: center;
  padding: 6px 8px; gap: 6px;
  border-top: 1px solid rgba(255,255,255,0.06);
  flex-shrink: 0;
}
#chat-input {
  flex: 1; padding: 7px 10px;
  border-radius: 16px;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.1);
  color: rgba(255,255,255,0.9);
  font-size: 12px;
  font-family: 'Segoe UI', system-ui, sans-serif;
  outline: none;
  transition: border-color 0.15s;
}
#chat-input:focus { border-color: rgba(255,255,255,0.25); }
#chat-input::placeholder { color: rgba(255,255,255,0.25); }
#chat-input:disabled { opacity: 0.4; cursor: not-allowed; }
#chat-send {
  width: 28px; height: 28px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 50%; border: none;
  background: rgba(255,255,255,0.1);
  color: rgba(255,255,255,0.5);
  font-size: 12px; cursor: pointer;
  transition: background 0.15s, color 0.15s;
}
#chat-send:hover { background: rgba(255,255,255,0.2); color: rgba(255,255,255,0.8); }
#chat-send:disabled { opacity: 0.3; cursor: not-allowed; }

/* No fadeIn animation — innerHTML rebuild would re-trigger it causing flicker */
</style>
</head>
<body oncontextmenu="return false">

<!-- Pill (collapsed) -->
<div id="pill">
  <div id="pill-left">
    <span id="pill-crab"></span>
    <span id="pill-q">?</span>
  </div>
  <div id="pill-center"></div>
  <div id="pill-right"></div>
  <div id="pill-hide" onclick="event.stopPropagation();hideIsland()" title="Hide">&minus;</div>
</div>

<!-- Panel (expanded) -->
<div id="panel">
  <div id="panel-header">
    <div id="header-crab"></div>
    <div id="header-spacer"></div>
    <div id="header-activity"></div>
    <button id="header-hide" onclick="hideIsland()" title="Hide">&minus;</button>
    <button id="header-menu">&#x2630;</button>
  </div>
  <div id="content">
    <div id="sessions"></div>
    <div id="settings">
      <div class="settings-row">
        <span class="settings-label">Hotkey</span>
        <div id="hotkey-box" class="hotkey-box" onclick="startCapture()">Alt+D</div>
      </div>
      <div class="settings-row">
        <span class="settings-label">Autostart</span>
        <div id="autostart-toggle" class="toggle-box off" onclick="toggleAutostart()">OFF</div>
      </div>
      <div class="settings-row">
        <span class="settings-label">Sound</span>
        <div id="sound-toggle" class="toggle-box on" onclick="toggleSound()">ON</div>
      </div>
      <div class="settings-row">
        <span class="settings-label">Complete</span>
        <select id="sound-stop" class="select-box">
          <option value="asterisk">Asterisk</option>
          <option value="hand">Hand</option>
          <option value="question">Question</option>
          <option value="exclamation">Exclamation</option>
          <option value="default">Default</option>
        </select>
      </div>
      <div class="settings-row">
        <span class="settings-label">Input</span>
        <select id="sound-notification" class="select-box">
          <option value="asterisk">Asterisk</option>
          <option value="hand">Hand</option>
          <option value="question">Question</option>
          <option value="exclamation">Exclamation</option>
          <option value="default">Default</option>
        </select>
      </div>
      <div class="settings-row">
        <span class="settings-label">Permission</span>
        <select id="sound-permission" class="select-box">
          <option value="asterisk">Asterisk</option>
          <option value="hand">Hand</option>
          <option value="question">Question</option>
          <option value="exclamation">Exclamation</option>
          <option value="default">Default</option>
        </select>
      </div>
      <div class="settings-actions">
        <button class="perm-btn deny" onclick="cancelSettings()">Cancel</button>
        <button class="perm-btn allow" onclick="saveSettings()">Save</button>
      </div>
    </div>
    <div id="chat-view">
      <div id="chat-header">
        <button id="chat-back" onclick="closeChat()">&#8249;</button>
        <span id="chat-title">Chat</span>
        <span id="chat-status"></span>
      </div>
      <div id="chat-messages"></div>
      <div id="chat-input-area">
        <input id="chat-input" type="text" placeholder="Send a message..."
               onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat();}">
        <button id="chat-send" onclick="sendChat()" title="Send">&#x27A4;</button>
      </div>
    </div>
  </div>
</div>

<script>
const API_PORT = window.API_PORT || 15924;
const BASE = `http://127.0.0.1:${API_PORT}`;

// ─── Config (fetched from backend, with JS defaults as fallback) ──
let CFG = {};
async function loadConfig() {
  try { CFG = await (await fetch(`${BASE}/api/island/config`)).json(); } catch(e) {}
  CFG.background         = CFG.background         || '#000000';
  CFG.color_active       = CFG.color_active       || '#D97857';
  CFG.color_ready        = CFG.color_ready         || '#66BF73';
  CFG.color_permission   = CFG.color_permission   || '#6699FF';
  CFG.color_notification = CFG.color_notification || '#FFB300';
  CFG.auto_collapse_ms   = CFG.auto_collapse_ms   || 3000;
  CFG.hover_expand_ms    = CFG.hover_expand_ms    || 400;
  CFG.hover_collapse_ms  = CFG.hover_collapse_ms  || 300;
  CFG.transparency       = CFG.transparency       || 'off';
  CFG.opacity            = (CFG.opacity !== undefined && CFG.opacity !== null) ? CFG.opacity : 0.75;
}

// ─── Colors (read from CFG) ──────────────────
const C = { get orange() { return CFG.color_active || '#D97857'; }, get green() { return CFG.color_ready || '#66BF73'; }, get blue() { return CFG.color_permission || '#6699FF'; } };

// ─── Pixel crab SVG ──────────────────────────
function crabSvg(size) {
  return `<svg width="${size}" height="${size}" viewBox="0 0 7 7" fill="${C.orange}" shape-rendering="crispEdges" style="display:block">`
    + '<rect x="1" y="0" width="1" height="1"/><rect x="5" y="0" width="1" height="1"/>'
    + '<rect x="1" y="1" width="1" height="1"/><rect x="5" y="1" width="1" height="1"/>'
    + '<rect x="1" y="2" width="5" height="1"/>'
    + '<rect x="0" y="3" width="7" height="1"/>'
    + '<rect x="1" y="4" width="5" height="1"/>'
    + '<rect x="2" y="5" width="1" height="1"/><rect x="4" y="5" width="1" height="1"/>'
    + '<rect x="1" y="6" width="1" height="1"/><rect x="5" y="6" width="1" height="1"/>'
    + '</svg>';
}

// ─── Spinner (character sequence) ────────────
const SPIN = ['\u00B7','\u2722','\u2733','\u2217','\u273B','\u273D'];
let spinF = 0;
setInterval(() => { spinF = (spinF + 1) % SPIN.length; updateSpinners(); }, 150);
function spinC() { return SPIN[spinF]; }
function updateSpinners() {
  document.querySelectorAll('.spin-char').forEach(el => { el.textContent = spinC(); });
}

// ─── State ───────────────────────────────────
let isExpanded = false;
let sessions = [];
let perms = [];
let permCountdowns = {}; // { id: { remaining, total } }
let hoverTimer = null;
let leaveTimer = null;
let autoCloseTimer = null;
let lastSH = '', lastPH = '';
let pillActive = false; // tracks pill width state (idle=narrow, active=wide)

// ─── Helpers ─────────────────────────────────
const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const trn = (s, n) => s.length > n ? s.slice(0, n - 1) + '\u2026' : s;
const proj = c => (c || '').split(/[/\\]/).pop() || '???';

// ─── Expand / Collapse ──────────────────────
// autoClose: true = hook-triggered, auto-collapse after configured ms
function doExpand(autoClose) {
  if (isExpanded) return;
  isExpanded = true;
  document.getElementById('pill').classList.add('hide');
  document.getElementById('panel').classList.add('show');
  fetch(`${BASE}/api/island/expand`, { method: 'POST' }).catch(() => {});
  fetchAll();
  markRead();
  if (autoClose) {
    if (autoCloseTimer) clearTimeout(autoCloseTimer);
    autoCloseTimer = setTimeout(doCollapse, CFG.auto_collapse_ms || 3000);
  }
}
function doCollapse() {
  if (!isExpanded) return;
  isExpanded = false;
  if (autoCloseTimer) { clearTimeout(autoCloseTimer); autoCloseTimer = null; }
  if (chatSession) closeChat();
  document.getElementById('panel').classList.remove('show');
  document.getElementById('pill').classList.remove('hide');
  fetch(`${BASE}/api/island/collapse`, { method: 'POST' }).catch(() => {});
}

document.getElementById('pill').addEventListener('click', () => doExpand(false));
document.getElementById('pill').addEventListener('mouseenter', () => { hoverTimer = setTimeout(() => doExpand(false), CFG.hover_expand_ms || 400); });
document.getElementById('pill').addEventListener('mouseleave', () => { if (hoverTimer) { clearTimeout(hoverTimer); hoverTimer = null; } });
document.addEventListener('mouseleave', () => { if (!isExpanded) return; leaveTimer = setTimeout(doCollapse, CFG.hover_collapse_ms || 300); });
document.addEventListener('mouseenter', () => {
  if (leaveTimer) { clearTimeout(leaveTimer); leaveTimer = null; }
  // User moved mouse into panel → cancel auto-close (wants to interact)
  if (autoCloseTimer) { clearTimeout(autoCloseTimer); autoCloseTimer = null; }
});
// Window blur (click outside / alt-tab) → collapse immediately
window.addEventListener('blur', () => { if (isExpanded) doCollapse(); });

function hideIsland() {
  if (isExpanded) doCollapse();
  fetch(`${BASE}/api/island/hide`, { method: 'POST' }).catch(() => {});
}

window.onExpand = () => doExpand(false);
window.onTrayState = function() {};

// ─── Mark read ──────────────────────────────
let mrTimer = null;
function markRead() {
  if (mrTimer) return;
  mrTimer = setTimeout(() => { mrTimer = null; fetch(`${BASE}/api/mark_read`, { method: 'POST' }).catch(() => {}); }, 500);
}

// ─── Pill width animation (idle ↔ active) ──
function checkPillState() {
  const hasActive = sessions.some(s => s.status === 'active');
  const hasPerm = perms.length > 0;
  const shouldBeActive = hasActive || hasPerm;
  if (shouldBeActive !== pillActive) {
    pillActive = shouldBeActive;
    fetch(`${BASE}/api/island/pill-state`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ active: shouldBeActive })
    }).catch(() => {});
  }
}

// ─── Pill ───────────────────────────────────
function updatePill() {
  const pillQ = document.getElementById('pill-q');
  const pillCenter = document.getElementById('pill-center');
  const pillRight = document.getElementById('pill-right');
  const hasPerm = perms.length > 0;
  const hasActive = sessions.some(s => s.status === 'active');

  // "?" indicator next to crab
  pillQ.style.display = hasPerm ? '' : 'none';

  // Center: status dots (multiple sessions, no perm)
  if (sessions.length > 1 && !hasPerm) {
    const mx = 8, vis = sessions.slice(0, mx), ov = sessions.length - mx;
    pillCenter.innerHTML = vis.map(s => {
      const pm = perms.find(p => p.session_id === s.session_id);
      const col = pm ? C.blue : s.status === 'active' ? C.orange : s.status === 'waiting' ? C.green : 'rgba(255,255,255,0.2)';
      return `<div class="pill-dot" style="background:${col}"></div>`;
    }).join('') + (ov > 0 ? `<span style="font-size:9px;color:rgba(255,255,255,0.4);font-weight:600;margin-left:2px">+${ov}</span>` : '');
  } else {
    pillCenter.innerHTML = '';
  }

  // Right: priority = perm > active > ready > none
  if (!sessions.length) {
    pillRight.innerHTML = '';
  } else if (hasPerm) {
    pillRight.innerHTML = `<div class="pill-static-dot" style="background:${C.orange}"></div>`;
  } else if (hasActive) {
    pillRight.innerHTML = `<span class="pill-spin spin-char">${spinC()}</span>`;
  } else {
    pillRight.innerHTML = `<div class="pill-static-dot" style="background:${C.green}"></div>`;
  }
}

// ─── Header ─────────────────────────────────
function updateHeader() {
  const activity = document.getElementById('header-activity');
  const hasPerm = perms.length > 0;
  const hasActive = sessions.some(s => s.status === 'active');

  if (hasPerm) {
    activity.innerHTML = `<span style="color:${C.orange}">\u00B7</span>`;
  } else if (hasActive) {
    activity.innerHTML = `<span class="spin-char" style="color:${C.orange}">${spinC()}</span>`;
  } else if (sessions.length) {
    activity.innerHTML = `<span style="color:${C.green}">\u2713\u2713</span>`;
  } else {
    activity.innerHTML = '';
  }
}

// ─── Sessions ───────────────────────────────
function renderSessions() {
  checkPillState();
  updatePill();
  updateHeader();
  const el = document.getElementById('sessions');
  if (!sessions.length) { el.innerHTML = '<div class="empty">No active sessions</div>'; return; }

  el.innerHTML = sessions.map((s, i) => {
    const nm = esc(proj(s.cwd));
    const pm = perms.find(p => p.session_id === s.session_id);

    // Indicator
    let ind;
    if (pm) {
      ind = `<span class="ind-char perm-spin" style="color:${C.orange}">+</span>`;
    } else if (s.status === 'active') {
      ind = `<span class="ind-char spin-char" style="color:${C.orange}">${spinC()}</span>`;
    } else if (s.status === 'waiting' && s.notification_message) {
      ind = `<div class="ind-dot" style="background:${CFG.color_notification || '#FFB300'}"></div>`;
    } else if (s.status === 'waiting') {
      ind = `<div class="ind-dot" style="background:${C.green}"></div>`;
    } else {
      ind = `<div class="ind-dot" style="background:rgba(255,255,255,0.2)"></div>`;
    }

    // Title & subtitle
    let title, sub;
    if (pm) {
      title = s.last_message ? esc(trn(s.last_message, 40)) : nm;
      const tn = pm.tool_name || 'Tool';
      const ti = typeof pm.tool_input === 'string' ? pm.tool_input : JSON.stringify(pm.tool_input || {});
      const cd = permCountdowns[pm.id];
      const cdStr = cd ? (() => { const m = Math.floor(cd.remaining / 60), s = cd.remaining % 60; const t = `${m}:${String(s).padStart(2,'0')}`; return cd.remaining < 60 ? ` <span style="color:#FF4444;font-weight:600">${t}</span>` : ` <span style="opacity:0.5">${t}</span>`; })() : '';
      sub = `<div class="sess-sub"><span class="tool-name">${esc(tn)}</span> ${esc(trn(ti, 50))}${cdStr}</div>`;
    } else {
      title = nm;
      let label, subCls = '';
      if (s.status === 'active') {
        label = 'Working...';
      } else if (s.notification_message) {
        label = 'Needs your input';
        subCls = ` style="color:${CFG.color_notification || '#FFB300'}"`;

      } else {
        label = 'Ready';
      }
      sub = `<div class="sess-sub"${subCls}>${esc(label)}</div>`;
    }

    // Actions
    let acts;
    if (pm) {
      acts = `<div class="sess-actions always">
        <button class="act-btn" onclick="event.stopPropagation();openChat(${i})" title="Chat">&#x1F4AC;</button>
        <button class="perm-btn deny" onclick="event.stopPropagation();rPerm('${pm.id}','deny')">Deny</button>
        <button class="perm-btn allow" onclick="event.stopPropagation();rPerm('${pm.id}','allow')">Allow</button>
      </div>`;
    } else {
      acts = `<div class="sess-actions">
        <button class="act-btn" onclick="event.stopPropagation();openChat(${i})" title="Chat">&#x1F4AC;</button>
        <button class="act-btn" onclick="event.stopPropagation();focusSess(${i})" title="Focus">&#x1F4FA;</button>
        <button class="act-btn" onclick="event.stopPropagation();dismissSess(${i})" title="Dismiss">&#x1F4E6;</button>
      </div>`;
    }

    return `<div class="sess-row" onclick="focusSess(${i})">
      <div class="ind">${ind}</div>
      <div class="sess-body">
        <div class="sess-name">${title}</div>
        ${sub}
      </div>
      ${acts}
    </div>`;
  }).join('');
}

// ─── Session actions ────────────────────────
function focusSess(i) {
  const s = sessions[i]; if (!s) return;
  const p = {};
  if (s.cwd) p.cwd = s.cwd;
  if (s.pid) p.pid = s.pid;
  fetch(`${BASE}/api/focus`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(p) }).catch(() => {});
}
function dismissSess(i) {
  const s = sessions[i]; if (!s || !s.session_id) return;
  fetch(`${BASE}/api/session/${s.session_id}`, { method: 'DELETE' }).catch(() => {});
}

// ─── Data contracts ─────────────────────────
/** @typedef {{ pid: number, name: string, agent_type: string, cwd: string, uptime: number, status: string, session_id: string, notification_type: string, notification_message: string, last_message: string, parent_session_id?: string }} Session */
/** @typedef {{ id: string, session_id: string, cwd: string, tool_name: string, tool_input: object, timestamp: number, timeout_secs: number }} Permission */

/** @param {object} raw @returns {Session} */
function validateSession(raw) {
  return {
    pid: raw.pid || 0,
    name: raw.name || '',
    agent_type: raw.agent_type || '',
    cwd: raw.cwd || '',
    uptime: raw.uptime || 0,
    status: raw.status || 'unknown',
    session_id: raw.session_id || '',
    notification_type: raw.notification_type || '',
    notification_message: raw.notification_message || '',
    last_message: raw.last_message || '',
    parent_session_id: raw.parent_session_id || null,
  };
}
/** @param {object} raw @returns {Permission} */
function validatePermission(raw) {
  return {
    id: raw.id || '',
    session_id: raw.session_id || '',
    cwd: raw.cwd || '',
    tool_name: raw.tool_name || '',
    tool_input: raw.tool_input || {},
    timestamp: raw.timestamp || 0,
    timeout_secs: raw.timeout_secs || 600,
  };
}

// ─── Permissions ────────────────────────────
function rPerm(id, decision) {
  fetch(`${BASE}/api/permission-respond`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, decision }) }).catch(() => {});
  perms = perms.filter(p => p.id !== id);
  delete permCountdowns[id];
  renderSessions();
}
async function fetchPerms() {
  try {
    const r = await fetch(`${BASE}/api/permissions`);
    const d = await r.json();
    const prev = perms.length;
    const newPerms = (d.requests || []).map(validatePermission);
    const ph = JSON.stringify(newPerms);
    if (ph !== lastPH) {
      lastPH = ph;
      perms = newPerms;
      if (perms.length > prev && perms.length > 0) doExpand(false);
      renderSessions();
    }
  } catch (e) {}
}

// ─── Data fetch ─────────────────────────────
// Hash only stable fields (uptime/create_time change every poll → causes flicker)
function sessHash(procs) {
  return JSON.stringify((procs||[]).map(p => [p.pid,p.status,p.session_id,p.cwd,p.last_message,p.notification_message]));
}
async function fetchAll() {
  try {
    const r = await fetch(`${BASE}/api/all`);
    const d = await r.json();
    const sh = sessHash(d.processes);
    if (sh !== lastSH) {
      lastSH = sh;
      sessions = (d.processes || []).map(validateSession);
      renderSessions();
    }
    if (isExpanded) markRead();
    // Sync chat session status if chat is open
    if (chatSession) {
      const cs = sessions.find(s => s.session_id === chatSession.session_id);
      if (cs) {
        chatSession.status = cs.status;
        chatSession.pid = cs.pid;
        updateChatStatus(cs.status);
        updateChatInputState();
      }
    }
  } catch (e) {}
}

// ─── SSE ────────────────────────────────────
let sseD = 1000, sse = null;
function connectSSE() {
  try {
    sse = new EventSource(`${BASE}/api/stream`);
    sse.onopen = () => { sseD = 1000; };
    sse.onmessage = e => { try {
      const m = JSON.parse(e.data);
      if (m.type === 'event') {
        const ev = m.event || (m.data && m.data.event) || '';
        if (ev === 'session_start' || ev === 'stop') doExpand(true);
        fetchAll();
        // Retry: process scanner cache is 5s, so re-fetch after delay
        if (ev === 'session_start') setTimeout(fetchAll, 3000);
      } else if (m.type === 'activity') {
        fetchAll();
      } else if (m.type === 'permission_request') {
        doExpand(false); // permission needs user action, don't auto-close
        if (m.timeout_secs) permCountdowns[m.id] = { remaining: m.timeout_secs, total: m.timeout_secs };
        fetchPerms();
      } else if (m.type === 'permission_countdown') {
        permCountdowns[m.id] = { remaining: m.remaining, total: m.total };
        renderSessions();
      } else if (m.type === 'chat_sent') {
        if (chatSession && m.session_id === chatSession.session_id) {
          setTimeout(fetchChat, 1000);
        }
      }
      // If chat is open, refresh on activity for this session
      if (chatSession && (m.type === 'activity' || m.type === 'event')) {
        const sid = m.session_id || (m.data && m.data.session_id);
        if (sid === chatSession.session_id) fetchChat();
      }
    } catch (_) {} };
    sse.onerror = () => { sse.close(); sse = null; setTimeout(connectSSE, sseD); sseD = Math.min(sseD * 2, 30000); };
  } catch (_) { setTimeout(connectSSE, sseD); sseD = Math.min(sseD * 2, 30000); }
}

// ─── Chat View ──────────────────────────────
let chatSession = null;     // { session_id, cwd, pid, status }
let chatMessages = [];
let chatNextIndex = 0;
let chatPollTimer = null;
let chatSending = false;

function openChat(i) {
  const s = sessions[i];
  if (!s || !s.session_id) return;
  chatSession = { session_id: s.session_id, cwd: s.cwd, pid: s.pid, status: s.status };
  chatMessages = [];
  chatNextIndex = 0;

  // Switch views
  document.getElementById('sessions').style.display = 'none';
  document.getElementById('settings').style.display = 'none';
  document.getElementById('chat-view').classList.add('show');
  showSettings = false;

  // Set header
  document.getElementById('chat-title').textContent = proj(s.cwd);
  updateChatStatus(s.status);
  updateChatInputState();

  // Fetch chat history + start polling
  fetchChat();
  chatPollTimer = setInterval(fetchChat, 2000);
}

function closeChat() {
  chatSession = null;
  chatMessages = [];
  chatNextIndex = 0;
  if (chatPollTimer) { clearInterval(chatPollTimer); chatPollTimer = null; }

  document.getElementById('chat-view').classList.remove('show');
  document.getElementById('sessions').style.display = '';
}

function updateChatStatus(status) {
  const el = document.getElementById('chat-status');
  if (status === 'active') {
    el.textContent = 'Working';
    el.className = 'cst-active';
  } else if (status === 'waiting' || status === 'idle') {
    el.textContent = 'Ready';
    el.className = 'cst-waiting';
  } else {
    el.textContent = status || '';
    el.className = 'cst-idle';
  }
}

function updateChatInputState() {
  if (!chatSession) return;
  const input = document.getElementById('chat-input');
  const btn = document.getElementById('chat-send');
  const active = chatSession.status === 'active';
  input.disabled = active;
  btn.disabled = active;
  input.placeholder = active ? 'Waiting for Claude to finish...' : 'Send a message...';
}

async function fetchChat() {
  if (!chatSession) return;
  try {
    const params = new URLSearchParams({
      session_id: chatSession.session_id,
      cwd: chatSession.cwd,
      after: chatNextIndex.toString(),
    });
    const r = await fetch(`${BASE}/api/chat/v2?${params}`);
    const d = await r.json();
    if (d.messages && d.messages.length > 0) {
      chatMessages = chatMessages.concat(d.messages);
      chatNextIndex = d.next_index;
      renderChat();
    }
  } catch (e) {}
}

function renderChat() {
  const el = document.getElementById('chat-messages');
  const wasBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 20;

  if (!chatMessages.length) {
    el.innerHTML = '<div class="chat-empty">No messages yet</div>';
    return;
  }

  el.innerHTML = chatMessages.map(m => {
    const ev = m.event;
    if (!ev) return '';
    switch (ev.type) {
      case 'text': {
        const cls = ev.role === 'user' ? 'user' : 'assistant';
        const txt = esc(ev.content || '').replace(/\n/g, '<br>')
          .replace(/`([^`]+)`/g, '<code style="background:rgba(255,255,255,0.08);padding:1px 4px;border-radius:3px">$1</code>');
        return `<div class="chat-msg ${cls}">${txt}</div>`;
      }
      case 'tool_call':
        return `<div class="chat-msg tool">\u{1F527} ${esc(ev.name || 'tool')}</div>`;
      case 'tool_result': {
        const c = esc(trn(ev.content || '', 120));
        const st = ev.is_error ? ' style="color:#FF6666"' : '';
        return `<div class="chat-msg tool"${st}>${c || '(no output)'}</div>`;
      }
      case 'thinking':
        return `<div class="chat-msg tool" style="font-style:italic;opacity:0.6">${esc(trn(ev.summary || '', 80))}</div>`;
      default: return '';
    }
  }).filter(Boolean).join('');

  if (wasBottom) el.scrollTop = el.scrollHeight;
}

async function sendChat() {
  if (!chatSession || chatSending) return;
  const input = document.getElementById('chat-input');
  const message = input.value.trim();
  if (!message) return;

  chatSending = true;
  input.disabled = true;
  document.getElementById('chat-send').disabled = true;

  try {
    const r = await fetch(`${BASE}/api/chat/send`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        session_id: chatSession.session_id,
        cwd: chatSession.cwd,
        pid: chatSession.pid,
        message: message,
      }),
    });
    const d = await r.json();
    if (d.ok) {
      input.value = '';
      // Optimistic: show sent message immediately
      chatMessages.push({
        uuid: 'local-' + Date.now(),
        timestamp: new Date().toISOString(),
        event: { type: 'text', role: 'user', content: message },
      });
      renderChat();
      document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
      setTimeout(fetchChat, 1500);
    } else {
      const err = d.error || 'Failed to send';
      input.value = '';
      input.placeholder = err;
      setTimeout(() => { if (!chatSending) updateChatInputState(); }, 3000);
    }
  } catch (e) {
    input.placeholder = 'Connection error';
    setTimeout(() => { if (!chatSending) updateChatInputState(); }, 3000);
  } finally {
    chatSending = false;
    updateChatInputState();
    input.focus();
  }
}

// ─── Settings ────────────────────────────────
let showSettings = false;
let capturing = false;
let pendingHotkey = null;
let originalHotkey = '';
let settingsData = {}; // live settings from backend

document.getElementById('header-menu').addEventListener('click', async () => {
  if (chatSession) closeChat();
  showSettings = !showSettings;
  document.getElementById('sessions').style.display = showSettings ? 'none' : '';
  document.getElementById('settings').style.display = showSettings ? 'block' : 'none';
  if (showSettings) {
    // Load live settings from backend
    try { settingsData = await (await fetch(`${BASE}/api/settings`)).json(); } catch(e) {}
    originalHotkey = settingsData.hotkey || CFG.hotkey || 'Alt+D';
    pendingHotkey = null;
    document.getElementById('hotkey-box').textContent = originalHotkey;
    document.getElementById('hotkey-box').classList.remove('capturing');
    // Sound
    const snd = settingsData.sound_enabled !== false;
    const tog = document.getElementById('sound-toggle');
    tog.textContent = snd ? 'ON' : 'OFF';
    tog.className = 'toggle-box ' + (snd ? 'on' : 'off');
    // Autostart
    const as_ = settingsData.autostart === true;
    const asTog = document.getElementById('autostart-toggle');
    asTog.textContent = as_ ? 'ON' : 'OFF';
    asTog.className = 'toggle-box ' + (as_ ? 'on' : 'off');
    document.getElementById('sound-stop').value = settingsData.sound_stop || 'asterisk';
    document.getElementById('sound-notification').value = settingsData.sound_notification || 'exclamation';
    document.getElementById('sound-permission').value = settingsData.sound_permission || 'question';
  } else {
    cancelCapture();
  }
});

function toggleSound() {
  const tog = document.getElementById('sound-toggle');
  const isOn = tog.classList.contains('on');
  tog.textContent = isOn ? 'OFF' : 'ON';
  tog.className = 'toggle-box ' + (isOn ? 'off' : 'on');
}

function toggleAutostart() {
  const tog = document.getElementById('autostart-toggle');
  const isOn = tog.classList.contains('on');
  tog.textContent = isOn ? 'OFF' : 'ON';
  tog.className = 'toggle-box ' + (isOn ? 'off' : 'on');
}

function startCapture() {
  capturing = true;
  pendingHotkey = null;
  const box = document.getElementById('hotkey-box');
  box.textContent = 'Press keys\u2026';
  box.classList.add('capturing');
  // Unregister current hotkey so OS doesn't swallow it
  fetch(`${BASE}/api/hotkey/capture`, { method: 'POST' }).catch(() => {});
}

function cancelCapture() {
  if (capturing) {
    capturing = false;
    document.getElementById('hotkey-box').classList.remove('capturing');
    // Re-register old hotkey
    fetch(`${BASE}/api/hotkey/save`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ hotkey: originalHotkey })
    }).catch(() => {});
  }
}

document.addEventListener('keydown', (e) => {
  if (!capturing) return;
  e.preventDefault();
  e.stopPropagation();
  const parts = [];
  if (e.ctrlKey) parts.push('Ctrl');
  if (e.altKey) parts.push('Alt');
  if (e.shiftKey) parts.push('Shift');
  if (e.metaKey) parts.push('Super');
  const key = e.key;
  if (['Control','Alt','Shift','Meta'].includes(key)) return; // modifier only
  // Normalize key name
  const kn = key.length === 1 ? key.toUpperCase() : key;
  parts.push(kn);
  capturing = false;
  pendingHotkey = parts.join('+');
  const box = document.getElementById('hotkey-box');
  box.textContent = pendingHotkey;
  box.classList.remove('capturing');
});

function cancelSettings() {
  cancelCapture();
  pendingHotkey = null;
  showSettings = false;
  document.getElementById('sessions').style.display = '';
  document.getElementById('settings').style.display = 'none';
}

async function saveSettings() {
  // Save hotkey if changed
  const hk = pendingHotkey || originalHotkey;
  if (hk !== originalHotkey || pendingHotkey) {
    try {
      const r = await fetch(`${BASE}/api/hotkey/save`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ hotkey: hk })
      });
      const d = await r.json();
      if (d.ok) {
        CFG.hotkey = hk;
        originalHotkey = hk;
        pendingHotkey = null;
      } else {
        document.getElementById('hotkey-box').textContent = (d.error || 'Error') + ' \u2014 try again';
        return;
      }
    } catch(e) {}
  } else if (capturing) {
    // Cancel capture without change
    cancelCapture();
  }
  // Save sound + autostart settings
  const soundOn = document.getElementById('sound-toggle').classList.contains('on');
  const soundStop = document.getElementById('sound-stop').value;
  const soundNotification = document.getElementById('sound-notification').value;
  const soundPermission = document.getElementById('sound-permission').value;
  const autostartOn = document.getElementById('autostart-toggle').classList.contains('on');
  try {
    await fetch(`${BASE}/api/settings`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        sound_enabled: soundOn,
        sound_stop: soundStop,
        sound_notification: soundNotification,
        sound_permission: soundPermission,
        autostart: autostartOn
      })
    });
  } catch(e) {}
  showSettings = false;
  document.getElementById('sessions').style.display = '';
  document.getElementById('settings').style.display = 'none';
}

// ─── Init ───────────────────────────────────
window.addEventListener('DOMContentLoaded', async () => {
  await loadConfig();
  // Apply config colors as CSS custom properties
  const root = document.documentElement.style;
  if (CFG.transparency !== 'off') {
    const hex = CFG.background.replace('#','');
    const r = parseInt(hex.substring(0,2), 16);
    const g = parseInt(hex.substring(2,4), 16);
    const b = parseInt(hex.substring(4,6), 16);
    root.setProperty('--bg', `rgba(${r},${g},${b},${CFG.opacity})`);
  } else {
    root.setProperty('--bg', CFG.background);
  }
  root.setProperty('--color-active', CFG.color_active);
  root.setProperty('--color-ready', CFG.color_ready);
  root.setProperty('--color-permission', CFG.color_permission);
  root.setProperty('--color-notification', CFG.color_notification);
  // Init crab SVGs (uses C.orange which reads from CFG)
  document.getElementById('pill-crab').innerHTML = crabSvg(14);
  document.getElementById('header-crab').innerHTML = crabSvg(16);
  fetchAll();
  fetchPerms();
  connectSSE();
  setInterval(fetchAll, 5000);
  setInterval(fetchPerms, 5000);
});
</script>
</body>
</html>
