<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
  background: #000;
  overflow: hidden;
  user-select: none;
  -webkit-user-select: none;
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  color: rgba(255,255,255,0.7);
  -webkit-font-smoothing: antialiased;
}

/* ─── Pill (collapsed) ─── */
#pill {
  display: flex;
  align-items: center;
  height: 36px;
  padding: 0 14px;
  cursor: pointer;
  background: #000;
}
#pill.hide { display: none; }

#pill-left {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-shrink: 0;
}
#pill-q {
  font-size: 14px;
  font-weight: 600;
  color: #D97857;
  display: none;
}

#pill-center {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
}
.pill-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  transition: background 0.3s;
}

#pill-right {
  display: flex;
  align-items: center;
  flex-shrink: 0;
}
.pill-spin {
  font-size: 12px;
  font-weight: bold;
  color: #D97857;
  width: 12px;
  text-align: center;
}
.pill-static-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
}

/* ─── Panel (expanded) ─── */
#panel {
  display: none;
  flex-direction: column;
  height: 100vh;
  background: #000;
}
#panel.show { display: flex; }

/* ─── Panel Header ─── */
#panel-header {
  display: flex;
  align-items: center;
  height: 38px;
  padding: 0 14px;
  gap: 8px;
  flex-shrink: 0;
}
#header-crab { flex-shrink: 0; display: flex; align-items: center; }
#header-spacer { flex: 1; }
#header-activity {
  font-size: 14px;
  font-weight: bold;
  display: flex;
  align-items: center;
}
#header-menu {
  width: 22px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: rgba(255,255,255,0.3);
  font-size: 11px;
  border-radius: 6px;
  transition: color 0.15s, background 0.15s;
  flex-shrink: 0;
  border: none;
  background: none;
}
#header-menu:hover { color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.08); }

/* ─── Content ─── */
#content {
  flex: 1;
  overflow-y: auto;
  padding: 4px 6px;
}
#content::-webkit-scrollbar { width: 3px; }
#content::-webkit-scrollbar-track { background: transparent; }
#content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

/* ─── Session row ─── */
.sess-row {
  display: flex;
  align-items: center;
  padding: 10px 8px;
  border-radius: 12px;
  margin-bottom: 1px;
  cursor: pointer;
  transition: background 0.15s;
  gap: 12px;
}
.sess-row:hover { background: rgba(255,255,255,0.06); }

.ind { width: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.ind-dot { width: 8px; height: 8px; border-radius: 50%; }
.ind-char {
  font-size: 14px;
  font-weight: bold;
  width: 14px;
  text-align: center;
  line-height: 1;
}

/* Permission "+" rotation */
@keyframes permSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
.perm-spin {
  display: inline-block;
  animation: permSpin 2s linear infinite;
}

.sess-body { flex: 1; min-width: 0; }
.sess-name {
  font-size: 13px;
  font-weight: 500;
  color: rgba(255,255,255,0.9);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.3;
}
.sess-sub {
  font-size: 11px;
  color: rgba(255,255,255,0.5);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-top: 1px;
}
.tool-name {
  color: #66BF73;
  font-weight: 500;
  font-family: 'Cascadia Code', 'Consolas', monospace;
}

/* Actions */
.sess-actions {
  display: flex;
  gap: 4px;
  flex-shrink: 0;
  opacity: 0;
  transition: opacity 0.15s;
  align-items: center;
}
.sess-row:hover .sess-actions { opacity: 1; }
.sess-actions.always { opacity: 1; }

.act-btn {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  cursor: pointer;
  color: rgba(255,255,255,0.35);
  font-size: 13px;
  transition: color 0.12s, background 0.12s;
  border: none;
  background: none;
}
.act-btn:hover { color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.08); }

.perm-btn {
  padding: 5px 10px;
  border: none;
  border-radius: 14px;
  font-size: 11px;
  font-weight: 500;
  cursor: pointer;
  transition: opacity 0.12s;
  white-space: nowrap;
}
.perm-btn:hover { opacity: 0.85; }
.perm-btn.allow { background: rgba(255,255,255,0.9); color: #000; }
.perm-btn.deny  { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.6); }

.empty {
  color: rgba(255,255,255,0.15);
  text-align: center;
  padding: 32px 0;
  font-size: 11px;
}

/* No fadeIn animation — innerHTML rebuild would re-trigger it causing flicker */
</style>
</head>
<body oncontextmenu="return false">

<!-- Pill (collapsed) -->
<div id="pill">
  <div id="pill-left">
    <span id="pill-crab"></span>
    <span id="pill-q">?</span>
  </div>
  <div id="pill-center"></div>
  <div id="pill-right"></div>
</div>

<!-- Panel (expanded) -->
<div id="panel">
  <div id="panel-header">
    <div id="header-crab"></div>
    <div id="header-spacer"></div>
    <div id="header-activity"></div>
    <button id="header-menu">&#x2630;</button>
  </div>
  <div id="content">
    <div id="sessions"></div>
  </div>
</div>

<script>
const API_PORT = window.API_PORT || 15924;
const BASE = `http://127.0.0.1:${API_PORT}`;

// ─── Colors ──────────────────────────────────
const C = { orange: '#D97857', green: '#66BF73', blue: '#6699FF' };

// ─── Pixel crab SVG ──────────────────────────
function crabSvg(size) {
  return `<svg width="${size}" height="${size}" viewBox="0 0 7 7" fill="${C.orange}" shape-rendering="crispEdges" style="display:block">`
    + '<rect x="1" y="0" width="1" height="1"/><rect x="5" y="0" width="1" height="1"/>'
    + '<rect x="1" y="1" width="1" height="1"/><rect x="5" y="1" width="1" height="1"/>'
    + '<rect x="1" y="2" width="5" height="1"/>'
    + '<rect x="0" y="3" width="7" height="1"/>'
    + '<rect x="1" y="4" width="5" height="1"/>'
    + '<rect x="2" y="5" width="1" height="1"/><rect x="4" y="5" width="1" height="1"/>'
    + '<rect x="1" y="6" width="1" height="1"/><rect x="5" y="6" width="1" height="1"/>'
    + '</svg>';
}

// ─── Spinner (character sequence) ────────────
const SPIN = ['\u00B7','\u2722','\u2733','\u2217','\u273B','\u273D'];
let spinF = 0;
setInterval(() => { spinF = (spinF + 1) % SPIN.length; updateSpinners(); }, 150);
function spinC() { return SPIN[spinF]; }
function updateSpinners() {
  document.querySelectorAll('.spin-char').forEach(el => { el.textContent = spinC(); });
}

// ─── State ───────────────────────────────────
let isExpanded = false;
let sessions = [];
let perms = [];
let hoverTimer = null;
let leaveTimer = null;
let autoCloseTimer = null;
let lastSH = '', lastPH = '';

// ─── Helpers ─────────────────────────────────
const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const trn = (s, n) => s.length > n ? s.slice(0, n - 1) + '\u2026' : s;
const proj = c => (c || '').split(/[/\\]/).pop() || '???';

// ─── Expand / Collapse ──────────────────────
// autoClose: true = hook-triggered, auto-collapse after 3s
function doExpand(autoClose) {
  if (isExpanded) return;
  isExpanded = true;
  document.getElementById('pill').classList.add('hide');
  document.getElementById('panel').classList.add('show');
  fetch(`${BASE}/api/island/expand`, { method: 'POST' }).catch(() => {});
  fetchAll();
  markRead();
  if (autoClose) {
    if (autoCloseTimer) clearTimeout(autoCloseTimer);
    autoCloseTimer = setTimeout(doCollapse, 3000);
  }
}
function doCollapse() {
  if (!isExpanded) return;
  isExpanded = false;
  if (autoCloseTimer) { clearTimeout(autoCloseTimer); autoCloseTimer = null; }
  document.getElementById('panel').classList.remove('show');
  document.getElementById('pill').classList.remove('hide');
  fetch(`${BASE}/api/island/collapse`, { method: 'POST' }).catch(() => {});
}

document.getElementById('pill').addEventListener('click', () => doExpand(false));
document.getElementById('pill').addEventListener('mouseenter', () => { hoverTimer = setTimeout(() => doExpand(false), 400); });
document.getElementById('pill').addEventListener('mouseleave', () => { if (hoverTimer) { clearTimeout(hoverTimer); hoverTimer = null; } });
document.addEventListener('mouseleave', () => { if (!isExpanded) return; leaveTimer = setTimeout(doCollapse, 300); });
document.addEventListener('mouseenter', () => {
  if (leaveTimer) { clearTimeout(leaveTimer); leaveTimer = null; }
  // User moved mouse into panel → cancel auto-close (wants to interact)
  if (autoCloseTimer) { clearTimeout(autoCloseTimer); autoCloseTimer = null; }
});
// Window blur (click outside / alt-tab) → collapse immediately
window.addEventListener('blur', () => { if (isExpanded) doCollapse(); });

window.onExpand = () => doExpand(false);
window.onTrayState = function() {};

// ─── Mark read ──────────────────────────────
let mrTimer = null;
function markRead() {
  if (mrTimer) return;
  mrTimer = setTimeout(() => { mrTimer = null; fetch(`${BASE}/api/mark_read`, { method: 'POST' }).catch(() => {}); }, 500);
}

// ─── Pill ───────────────────────────────────
function updatePill() {
  const pillQ = document.getElementById('pill-q');
  const pillCenter = document.getElementById('pill-center');
  const pillRight = document.getElementById('pill-right');
  const hasPerm = perms.length > 0;
  const hasActive = sessions.some(s => s.status === 'active');

  // "?" indicator next to crab
  pillQ.style.display = hasPerm ? '' : 'none';

  // Center: status dots (multiple sessions, no perm)
  if (sessions.length > 1 && !hasPerm) {
    const mx = 8, vis = sessions.slice(0, mx), ov = sessions.length - mx;
    pillCenter.innerHTML = vis.map(s => {
      const pm = perms.find(p => p.session_id === s.session_id);
      const col = pm ? C.blue : s.status === 'active' ? C.orange : s.status === 'waiting' ? C.green : 'rgba(255,255,255,0.2)';
      return `<div class="pill-dot" style="background:${col}"></div>`;
    }).join('') + (ov > 0 ? `<span style="font-size:9px;color:rgba(255,255,255,0.4);font-weight:600;margin-left:2px">+${ov}</span>` : '');
  } else {
    pillCenter.innerHTML = '';
  }

  // Right: priority = perm > active > ready > none
  if (!sessions.length) {
    pillRight.innerHTML = '';
  } else if (hasPerm) {
    pillRight.innerHTML = `<div class="pill-static-dot" style="background:${C.orange}"></div>`;
  } else if (hasActive) {
    pillRight.innerHTML = `<span class="pill-spin spin-char">${spinC()}</span>`;
  } else {
    pillRight.innerHTML = `<div class="pill-static-dot" style="background:${C.green}"></div>`;
  }
}

// ─── Header ─────────────────────────────────
function updateHeader() {
  const activity = document.getElementById('header-activity');
  const hasPerm = perms.length > 0;
  const hasActive = sessions.some(s => s.status === 'active');

  if (hasPerm) {
    activity.innerHTML = `<span style="color:${C.orange}">\u00B7</span>`;
  } else if (hasActive) {
    activity.innerHTML = `<span class="spin-char" style="color:${C.orange}">${spinC()}</span>`;
  } else if (sessions.length) {
    activity.innerHTML = `<span style="color:${C.green}">\u2713\u2713</span>`;
  } else {
    activity.innerHTML = '';
  }
}

// ─── Sessions ───────────────────────────────
function renderSessions() {
  updatePill();
  updateHeader();
  const el = document.getElementById('sessions');
  if (!sessions.length) { el.innerHTML = '<div class="empty">No active sessions</div>'; return; }

  el.innerHTML = sessions.map((s, i) => {
    const nm = esc(proj(s.cwd));
    const pm = perms.find(p => p.session_id === s.session_id);

    // Indicator
    let ind;
    if (pm) {
      ind = `<span class="ind-char perm-spin" style="color:${C.orange}">+</span>`;
    } else if (s.status === 'active') {
      ind = `<span class="ind-char spin-char" style="color:${C.orange}">${spinC()}</span>`;
    } else if (s.status === 'waiting' && s.notification_message) {
      ind = `<div class="ind-dot" style="background:#FFB300"></div>`;
    } else if (s.status === 'waiting') {
      ind = `<div class="ind-dot" style="background:${C.green}"></div>`;
    } else {
      ind = `<div class="ind-dot" style="background:rgba(255,255,255,0.2)"></div>`;
    }

    // Title & subtitle
    let title, sub;
    if (pm) {
      title = s.last_message ? esc(trn(s.last_message, 40)) : nm;
      const tn = pm.tool_name || 'Tool';
      const ti = typeof pm.tool_input === 'string' ? pm.tool_input : JSON.stringify(pm.tool_input || {});
      sub = `<div class="sess-sub"><span class="tool-name">${esc(tn)}</span> ${esc(trn(ti, 50))}</div>`;
    } else {
      title = nm;
      let label, subCls = '';
      if (s.status === 'active') {
        label = 'Working...';
      } else if (s.notification_message) {
        label = 'Needs your input';
        subCls = ' style="color:#FFB300"';
      } else {
        label = 'Ready';
      }
      sub = `<div class="sess-sub"${subCls}>${esc(label)}</div>`;
    }

    // Actions
    let acts;
    if (pm) {
      acts = `<div class="sess-actions always">
        <button class="act-btn" onclick="event.stopPropagation();focusSess(${i})" title="Chat">&#x1F4AC;</button>
        <button class="perm-btn deny" onclick="event.stopPropagation();rPerm('${pm.id}','deny')">Deny</button>
        <button class="perm-btn allow" onclick="event.stopPropagation();rPerm('${pm.id}','allow')">Allow</button>
      </div>`;
    } else {
      acts = `<div class="sess-actions">
        <button class="act-btn" onclick="event.stopPropagation();focusSess(${i})" title="Chat">&#x1F4AC;</button>
        <button class="act-btn" onclick="event.stopPropagation();focusSess(${i})" title="Focus">&#x1F4FA;</button>
        <button class="act-btn" onclick="event.stopPropagation();dismissSess(${i})" title="Dismiss">&#x1F4E6;</button>
      </div>`;
    }

    return `<div class="sess-row" onclick="focusSess(${i})">
      <div class="ind">${ind}</div>
      <div class="sess-body">
        <div class="sess-name">${title}</div>
        ${sub}
      </div>
      ${acts}
    </div>`;
  }).join('');
}

// ─── Session actions ────────────────────────
function focusSess(i) {
  const s = sessions[i]; if (!s) return;
  const p = {};
  if (s.cwd) p.cwd = s.cwd;
  if (s.pid) p.pid = s.pid;
  fetch(`${BASE}/api/focus`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(p) }).catch(() => {});
}
function dismissSess(i) {
  const s = sessions[i]; if (!s || !s.session_id) return;
  fetch(`${BASE}/api/session/${s.session_id}`, { method: 'DELETE' }).catch(() => {});
}

// ─── Permissions ────────────────────────────
function rPerm(id, decision) {
  fetch(`${BASE}/api/permission-respond`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, decision }) }).catch(() => {});
  perms = perms.filter(p => p.id !== id);
  renderSessions();
}
async function fetchPerms() {
  try {
    const r = await fetch(`${BASE}/api/permissions`);
    const d = await r.json();
    const prev = perms.length;
    const newPerms = d.requests || [];
    const ph = JSON.stringify(newPerms);
    if (ph !== lastPH) {
      lastPH = ph;
      perms = newPerms;
      if (perms.length > prev && perms.length > 0) doExpand(false);
      renderSessions();
    }
  } catch (e) {}
}

// ─── Data fetch ─────────────────────────────
// Hash only stable fields (uptime/create_time change every poll → causes flicker)
function sessHash(procs) {
  return JSON.stringify((procs||[]).map(p => [p.pid,p.status,p.session_id,p.cwd,p.last_message,p.notification_message]));
}
async function fetchAll() {
  try {
    const r = await fetch(`${BASE}/api/all`);
    const d = await r.json();
    const sh = sessHash(d.processes);
    if (sh !== lastSH) {
      lastSH = sh;
      sessions = d.processes || [];
      renderSessions();
    }
    if (isExpanded) markRead();
  } catch (e) {}
}

// ─── SSE ────────────────────────────────────
let sseD = 1000, sse = null;
function connectSSE() {
  try {
    sse = new EventSource(`${BASE}/api/stream`);
    sse.onopen = () => { sseD = 1000; };
    sse.onmessage = e => { try {
      const m = JSON.parse(e.data);
      if (m.type === 'event') {
        const ev = m.event || (m.data && m.data.event) || '';
        if (ev === 'session_start' || ev === 'stop') doExpand(true);
        fetchAll();
        // Retry: process scanner cache is 5s, so re-fetch after delay
        if (ev === 'session_start') setTimeout(fetchAll, 3000);
      } else if (m.type === 'activity') {
        fetchAll();
      } else if (m.type === 'permission_request') {
        doExpand(false); // permission needs user action, don't auto-close
        fetchPerms();
      }
    } catch (_) {} };
    sse.onerror = () => { sse.close(); sse = null; setTimeout(connectSSE, sseD); sseD = Math.min(sseD * 2, 30000); };
  } catch (_) { setTimeout(connectSSE, sseD); sseD = Math.min(sseD * 2, 30000); }
}

// ─── Init ───────────────────────────────────
window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('pill-crab').innerHTML = crabSvg(14);
  document.getElementById('header-crab').innerHTML = crabSvg(16);
  fetchAll();
  fetchPerms();
  connectSSE();
  setInterval(fetchAll, 5000);
  setInterval(fetchPerms, 5000);
});
</script>
</body>
</html>
